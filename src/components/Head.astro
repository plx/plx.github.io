---
import "../styles/global.css";
import "@fontsource/inter/latin-400.css";
import "@fontsource/inter/latin-600.css";
import "@fontsource/lora/400.css";
import "@fontsource/lora/600.css";
import inter400 from "@fontsource/inter/files/inter-latin-400-normal.woff2";
import inter600 from "@fontsource/inter/files/inter-latin-600-normal.woff2";
import lora400 from "@fontsource/lora/files/lora-latin-400-normal.woff2";
import lora600 from "@fontsource/lora/files/lora-latin-600-normal.woff2";

import { ClientRouter } from "astro:transitions";
import { SITE } from "@consts";
import OpenGraphMeta from "@components/OpenGraphMeta.astro";
import type { OpenGraphData } from "@lib/opengraph";
import { generateTailgraphURL } from "@lib/opengraph";

interface Props {
  title: string;
  description: string;
  image?: string;
  ogData?: OpenGraphData;
}

const canonicalURL = new URL(Astro.url.pathname, Astro.site);

const { title, description, image = "/Logo.jpeg", ogData } = Astro.props;

// Create default OG data if not provided
const defaultOgData: OpenGraphData = ogData || {
  title,
  description,
  type: "website",
  url: canonicalURL.toString(),
  siteName: SITE.NAME,
  image: image.startsWith("http") ? image : generateTailgraphURL({
    title,
    theme: "dark",
    backgroundImage: "gradient",
    logo: `${Astro.site}Logo-144.jpeg`
  }),
  twitter: {
    card: "summary_large_image"
  }
};
---

<!-- Global Metadata -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />

<!-- Favicons -->
<link rel="icon" type="image/png" sizes="48x48" href="/favicon-48x48.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="manifest" href="/site.webmanifest">
<meta name="msapplication-TileColor" content="#ffffff">
<meta name="msapplication-TileImage" content="/mstile-150x150.png">
<meta name="theme-color" content="#ffffff">

<meta name="generator" content={Astro.generator} />

<!-- Font preloads -->
<link rel="preload" href={inter400} as="font" type="font/woff2" crossorigin/>
<link rel="preload" href={inter600} as="font" type="font/woff2" crossorigin/>
<link rel="preload" href={lora400} as="font" type="font/woff2" crossorigin/>
<link rel="preload" href={lora600} as="font" type="font/woff2" crossorigin/>

<!-- Canonical URL -->
<link rel="canonical" href={canonicalURL} />

<!-- Primary Meta Tags -->
<title>{title}</title>
<meta name="title" content={title} />
<meta name="description" content={description} />

<!-- OpenGraph Meta Tags -->
{ogData ? (
  <OpenGraphMeta data={ogData} />
) : (
  <OpenGraphMeta data={defaultOgData} />
)}

<ClientRouter  />

<!-- RSS Link -->
<link rel="alternate" type="application/rss+xml" title={SITE.NAME} href={new URL("rss.xml", Astro.site)} />

<script>
  import type { TransitionBeforeSwapEvent } from "astro:transitions/client";
  document.addEventListener("astro:before-swap", (e) =>
    [
      ...(e as TransitionBeforeSwapEvent).newDocument.head.querySelectorAll(
        "link[as=\"font\"]"
      ),
    ].forEach((link) => link.remove())
  );
</script>

<script is:inline>
  const colorSchemeMedia = window.matchMedia("(prefers-color-scheme: dark)");

  function init() {
    onScroll();
    animate();

    const backToTop = document.getElementById("back-to-top");
    backToTop?.removeEventListener("click", handleScrollToTop);
    backToTop?.addEventListener("click", handleScrollToTop);

    const backToPrev = document.getElementById("back-to-prev");
    backToPrev?.removeEventListener("click", handleBackToPrev);
    backToPrev?.addEventListener("click", handleBackToPrev);

    const skipLink = document.querySelector(".skip-link");
    skipLink?.removeEventListener("click", focusMainContent);
    skipLink?.addEventListener("click", focusMainContent);

    document
      .querySelectorAll("[data-theme-button]")
      .forEach((button) => {
        if (button.dataset.initialized === "true") return;
        button.dataset.initialized = "true";
        button.addEventListener("click", () => {
          const preference = button.getAttribute("data-theme-button");
          if (preference) {
            setThemePreference(preference);
          }
        });
      });

    updateThemeButtons(getThemePreference());

    document.removeEventListener("scroll", onScroll);
    document.addEventListener("scroll", onScroll);
  }

  function animate() {
    const animateElements = document.querySelectorAll(".animate");

    animateElements.forEach((element, index) => {
      setTimeout(() => {
        element.classList.add("show");
      }, index * 150);
    });
  }

  function onScroll() {
    if (window.scrollY > 0) {
      document.documentElement.classList.add("scrolled");
    } else {
      document.documentElement.classList.remove("scrolled");
    }
  }

  function handleScrollToTop(event) {
    event.preventDefault();
    window.scrollTo({
      top: 0,
      behavior: "smooth"
    });
  }

  function handleBackToPrev(event) {
    if (window.history.length > 1) {
      event.preventDefault();
      window.history.back();
    }
  }

  function focusMainContent() {
    requestAnimationFrame(() => {
      const main = document.getElementById("main-content");
      if (main) {
        main.focus();
      }
    });
  }

  function toggleTheme(dark) {
    const css = document.createElement("style");

    css.appendChild(
      document.createTextNode(
        `* {
             -webkit-transition: none !important;
             -moz-transition: none !important;
             -o-transition: none !important;
             -ms-transition: none !important;
             transition: none !important;
          }
        `,
      )
    );

    document.head.appendChild(css);

    if (dark) {
      document.documentElement.classList.add("dark");
    } else {
      document.documentElement.classList.remove("dark");
    }

    window.getComputedStyle(css).opacity;
    document.head.removeChild(css);
  }

  function getThemePreference() {
    const stored = localStorage.getItem("theme");
    return stored === "light" || stored === "dark" || stored === "system"
      ? stored
      : "system";
  }

  function resolveDarkMode(preference) {
    if (preference === "dark") return true;
    if (preference === "light") return false;
    return colorSchemeMedia.matches;
  }

  function updateThemeButtons(activePreference) {
    document
      .querySelectorAll("[data-theme-button]")
      .forEach((button) => {
        const value = button.getAttribute("data-theme-button");
        button.setAttribute("aria-pressed", value === activePreference ? "true" : "false");
      });
  }

  function setThemePreference(preference) {
    localStorage.setItem("theme", preference);
    toggleTheme(resolveDarkMode(preference));
    updateThemeButtons(preference);
  }

  function preloadTheme() {
    const preference = getThemePreference();
    toggleTheme(resolveDarkMode(preference));
  }

  colorSchemeMedia.addEventListener("change", (event) => {
    if (getThemePreference() === "system") {
      toggleTheme(event.matches);
      updateThemeButtons("system");
    }
  });

  document.addEventListener("DOMContentLoaded", init);
  document.addEventListener("astro:after-swap", init);
  preloadTheme();
</script>
